<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | TareeQ Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- مكتبة الرسم البياني -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { primary: '#6366f1', secondary: '#4f46e5', darkBg: '#0f172a', cardDark: '#1e293b' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .active-link { background-color: rgba(99, 102, 241, 0.1); color: #6366f1; font-weight: bold; border-right: 4px solid #6366f1; }
        .dark .active-link { background-color: rgba(99, 102, 241, 0.2); color: #818cf8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-darkBg dark:text-gray-100 font-sans transition-colors duration-300">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-cardDark border-l dark:border-gray-700 hidden md:flex flex-col shadow-lg z-20">
            <div class="h-16 flex items-center justify-center border-b dark:border-gray-700">
                <div class="flex items-center gap-2 font-bold text-xl text-primary cursor-pointer" onclick="window.location.reload()">
                    <i class="fas fa-chart-line"></i>
                    <span>لوحة القيادة</span>
                </div>
            </div>
            
            <nav class="flex-1 py-4 px-3 space-y-1">
                <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="active-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-home w-5"></i> نظرة عامة
                </a>
                <a href="#" onclick="switchTab('orders')" id="nav-orders" class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-shopping-cart w-5"></i> الطلبات
                </a>
                <a href="#" onclick="switchTab('customers')" id="nav-customers" class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-users w-5"></i> العملاء
                </a>
                
                <a href="index.html" class="flex items-center gap-3 px-4 py-3 mt-8 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-store text-primary"></i> زيارة المتجر
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            
            <header class="h-16 bg-white dark:bg-cardDark border-b dark:border-gray-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-2">
                    <h2 class="text-lg font-bold" id="page-title">نظرة عامة</h2>
                    <button onclick="fetchData()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400" title="تحديث البيانات"><i class="fas fa-sync-alt text-xs"></i></button>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-moon"></i></button>
            </header>

            <main class="flex-1 overflow-y-auto p-6 scroll-smooth relative">
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <!-- Sales -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm text-gray-500 mb-1">إجمالي المبيعات</p><h3 class="text-2xl font-bold text-primary" id="total-sales-display">$0.00</h3></div>
                            <div class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                    </div>
                    <!-- Orders -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm text-gray-500 mb-1">عدد الطلبات</p><h3 class="text-2xl font-bold dark:text-white" id="total-orders-display">0</h3></div>
                            <div class="p-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-lg"><i class="fas fa-shopping-bag"></i></div>
                        </div>
                    </div>
                    <!-- Customers -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm text-gray-500 mb-1">عدد العملاء</p><h3 class="text-2xl font-bold text-green-500" id="total-customers-display">0</h3></div>
                            <div class="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-lg"><i class="fas fa-users"></i></div>
                        </div>
                    </div>
                    <!-- Visitors (New) -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm text-gray-500 mb-1">زيارات الموقع</p><h3 class="text-2xl font-bold text-orange-500" id="total-visits-display">0</h3></div>
                            <div class="p-2 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-lg"><i class="fas fa-eye"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Home View -->
                <div id="dashboard-view" class="animate-fade-in space-y-8">
                    <!-- Chart Section -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-4 dark:text-white">إحصائيات المبيعات (آخر 7 أيام)</h3>
                        <div class="relative h-72 w-full">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Recent Orders Snippet -->
                    <div class="bg-white dark:bg-cardDark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h3 class="font-bold text-lg dark:text-white">أحدث الطلبات</h3>
                            <button onclick="switchTab('orders')" class="text-primary text-sm hover:underline">عرض الكل</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right" id="recent-orders-table">
                                <thead class="bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500">
                                    <tr><th class="px-6 py-3">رقم الطلب</th><th class="px-6 py-3">العميل</th><th class="px-6 py-3">المبلغ</th><th class="px-6 py-3">الحالة</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 dark:divide-gray-700 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Orders View -->
                <div id="orders-view" class="bg-white dark:bg-cardDark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden animate-fade-in hidden">
                    <div class="p-6 border-b dark:border-gray-700"><h3 class="font-bold text-lg dark:text-white">كل الطلبات</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500">
                                <tr><th class="px-6 py-3">رقم الطلب</th><th class="px-6 py-3">العميل</th><th class="px-6 py-3">العنوان</th><th class="px-6 py-3">المبلغ</th><th class="px-6 py-3">الحالة</th></tr>
                            </thead>
                            <tbody id="orders-table-body" class="divide-y divide-gray-100 dark:divide-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Customers View -->
                <div id="customers-view" class="bg-white dark:bg-cardDark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden animate-fade-in hidden">
                    <div class="p-6 border-b dark:border-gray-700"><h3 class="font-bold text-lg dark:text-white">قائمة العملاء</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500">
                                <tr><th class="px-6 py-3">الاسم</th><th class="px-6 py-3">الهاتف</th><th class="px-6 py-3">العنوان</th><th class="px-6 py-3">عدد الطلبات</th><th class="px-6 py-3">تواصل</th></tr>
                            </thead>
                            <tbody id="customers-table-body" class="divide-y divide-gray-100 dark:divide-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        let firebaseConfig;
        let isPreviewMode = false;
        let appId = 'default-app-id';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            isPreviewMode = true;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyBH7Lxi6qGoVej3PImRv1ndczeihLgucaI",
                authDomain: "elitestore-a55c1.firebaseapp.com",
                projectId: "elitestore-a55c1",
                storageBucket: "elitestore-a55c1.firebasestorage.app",
                messagingSenderId: "238502514492",
                appId: "1:238502514492:web:7feca9e75f5c5c7e4b9839",
                measurementId: "G-JR6FZ45FPG"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let allOrders = [];
        let salesChartInstance = null;

        // Auth
        async function initAuth() {
            try {
                if (isPreviewMode && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth Error:", error); }
        }
        onAuthStateChanged(auth, (user) => { if (user) fetchData(); });

        // Fetch Data
        window.fetchData = async function() {
            try {
                // 1. Get Orders
                let ordersRef;
                if (isPreviewMode) { ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders'); }
                else { ordersRef = collection(db, 'orders'); }
                
                const querySnapshot = await getDocs(ordersRef);
                allOrders = [];
                let totalSales = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allOrders.push({ id: doc.id, ...data });
                });

                allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Process Stats
                allOrders.forEach(order => {
                    let priceVal = 0;
                    if(order.total) priceVal = parseFloat(order.total.toString().replace(/[^0-9.-]+/g,""));
                    totalSales += priceVal;
                });

                document.getElementById('total-sales-display').innerText = `$${totalSales.toFixed(2)}`;
                document.getElementById('total-orders-display').innerText = allOrders.length;

                renderOrdersTable();
                renderCustomersTable();
                renderSalesChart(); // Render Chart

                // 2. Get Visits
                let statsRef;
                if (isPreviewMode) { statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'general'); }
                else { statsRef = doc(db, 'stats', 'general'); }
                
                const statsSnap = await getDoc(statsRef);
                if (statsSnap.exists()) {
                    document.getElementById('total-visits-display').innerText = statsSnap.data().visits || 0;
                } else {
                    document.getElementById('total-visits-display').innerText = "0";
                }

            } catch (error) { console.error("Fetch Error:", error); }
        }

        // Render Chart
        function renderSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // Prepare Data: Group by Date (Last 7 days)
            const days = {};
            // Init last 7 days with 0
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('en-CA'); // YYYY-MM-DD
                days[dateStr] = 0;
            }

            allOrders.forEach(order => {
                if(order.date) {
                    const dateStr = order.date.split('T')[0]; // simple ISO split
                    if (days[dateStr] !== undefined) {
                        let price = parseFloat(order.total.toString().replace(/[^0-9.-]+/g,"")) || 0;
                        days[dateStr] += price;
                    }
                }
            });

            const labels = Object.keys(days);
            const data = Object.values(days);

            if (salesChartInstance) salesChartInstance.destroy();

            const isDark = document.documentElement.classList.contains('dark');
            
            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'المبيعات ($)',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: isDark ? '#374151' : '#e5e7eb' },
                            ticks: { color: isDark ? '#9ca3af' : '#4b5563' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: isDark ? '#9ca3af' : '#4b5563' }
                        }
                    }
                }
            });
        }

        function renderOrdersTable() {
            const fullTableBody = document.getElementById('orders-table-body');
            const recentTableBody = document.querySelector('#recent-orders-table tbody');
            
            // Render Recent (First 5)
            const recentHTML = allOrders.slice(0, 5).map(o => createOrderRow(o)).join('');
            recentTableBody.innerHTML = recentHTML || '<tr><td colspan="4" class="text-center py-4">لا توجد طلبات</td></tr>';

            // Render All
            const fullHTML = allOrders.map(o => createOrderRow(o, true)).join('');
            fullTableBody.innerHTML = fullHTML || '<tr><td colspan="5" class="text-center py-8">لا توجد طلبات</td></tr>';
        }

        function createOrderRow(order, showAddress=false) {
            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700 last:border-0">
                    <td class="px-6 py-4 font-mono text-xs text-gray-500">#${order.id.slice(0,6)}</td>
                    <td class="px-6 py-4 font-bold dark:text-white">
                        <div>${order.customerName || 'مجهول'}</div>
                    </td>
                    ${showAddress ? `<td class="px-6 py-4 text-xs text-gray-500 truncate max-w-xs">${order.address || '-'}</td>` : ''}
                    <td class="px-6 py-4 text-primary font-bold">${order.total || '$0.00'}</td>
                    <td class="px-6 py-4"><span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">جديد</span></td>
                </tr>
            `;
        }

        function renderCustomersTable() {
            const customersMap = new Map();
            allOrders.forEach(order => {
                const phone = order.phone || 'unknown';
                if (!customersMap.has(phone)) {
                    customersMap.set(phone, { name: order.customerName, phone: phone, address: order.address, count: 1 });
                } else {
                    customersMap.get(phone).count++;
                }
            });
            const customers = Array.from(customersMap.values()).filter(c => c.phone !== 'unknown');
            document.getElementById('total-customers-display').innerText = customers.length;
            const tableBody = document.getElementById('customers-table-body');
            tableBody.innerHTML = customers.map(c => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700">
                    <td class="px-6 py-4 font-bold dark:text-white">${c.name}</td>
                    <td class="px-6 py-4 text-gray-500">${c.phone}</td>
                    <td class="px-6 py-4 text-xs text-gray-500 truncate max-w-xs">${c.address}</td>
                    <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">${c.count} طلبات</span></td>
                    <td class="px-6 py-4"><a href="https://wa.me/2${c.phone}" target="_blank" class="text-green-500 hover:text-green-600 border border-green-500 rounded px-2 py-1 text-xs"><i class="fab fa-whatsapp"></i> تواصل</a></td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center py-8">لا يوجد عملاء</td></tr>';
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.sidebar-link').forEach(l => {
                l.classList.remove('active-link'); l.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            document.getElementById('nav-' + tabName).classList.add('active-link');

            const title = document.getElementById('page-title');
            const dashboardView = document.getElementById('dashboard-view');
            const ordersView = document.getElementById('orders-view');
            const customersView = document.getElementById('customers-view');

            dashboardView.classList.add('hidden');
            ordersView.classList.add('hidden');
            customersView.classList.add('hidden');

            if (tabName === 'dashboard') {
                title.innerText = 'نظرة عامة';
                dashboardView.classList.remove('hidden');
            } else if (tabName === 'orders') {
                title.innerText = 'إدارة الطلبات';
                ordersView.classList.remove('hidden');
            } else {
                title.innerText = 'سجل العملاء';
                customersView.classList.remove('hidden');
            }
        }

        initAuth();
        document.getElementById('theme-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            renderSalesChart(); // Re-render to fix colors
        };
    </script>
</body>
</html>
