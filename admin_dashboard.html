<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | TareeQ Admin</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: { primary: '#6366f1', secondary: '#4f46e5', darkBg: '#0f172a', cardDark: '#1e293b' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .active-link { background-color: rgba(99, 102, 241, 0.1); color: #6366f1; font-weight: bold; border-right: 4px solid #6366f1; }
        .dark .active-link { background-color: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-darkBg dark:text-gray-100 font-sans transition-colors duration-300">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-cardDark border-l dark:border-gray-700 hidden md:flex flex-col shadow-lg z-20">
            <div class="h-16 flex items-center justify-center border-b dark:border-gray-700">
                <div class="flex items-center gap-2 font-bold text-xl text-primary cursor-pointer" onclick="window.location.reload()">
                    <i class="fas fa-chart-line"></i>
                    <span>لوحة القيادة</span>
                </div>
            </div>
            
            <nav class="flex-1 py-4 px-3 space-y-1">
                <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="active-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-home w-5"></i> نظرة عامة
                </a>
                <a href="#" onclick="switchTab('products')" id="nav-products" class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-box-open w-5"></i> إدارة المنتجات
                </a>
                <a href="#" onclick="switchTab('orders')" id="nav-orders" class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-shopping-cart w-5"></i> الطلبات
                </a>
                <a href="#" onclick="switchTab('customers')" id="nav-customers" class="flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors sidebar-link">
                    <i class="fas fa-users w-5"></i> العملاء
                </a>
                
                <a href="index.html" target="_blank" class="flex items-center gap-3 px-4 py-3 mt-8 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-store text-primary"></i> زيارة المتجر
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            
            <header class="h-16 bg-white dark:bg-cardDark border-b dark:border-gray-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-2">
                    <h2 class="text-lg font-bold" id="page-title">نظرة عامة</h2>
                    <button onclick="fetchData(); loadProducts();" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400" title="تحديث"><i class="fas fa-sync-alt text-xs"></i></button>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-moon"></i></button>
            </header>

            <main class="flex-1 overflow-y-auto p-6 scroll-smooth relative">
                
                <!-- Dashboard Home View -->
                <div id="dashboard-view" class="animate-fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <!-- Sales -->
                        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-start">
                                <div><p class="text-sm text-gray-500 mb-1">إجمالي المبيعات</p><h3 class="text-2xl font-bold text-primary" id="total-sales-display">0.00 ج.م</h3></div>
                                <div class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg"><i class="fas fa-coins"></i></div>
                            </div>
                        </div>
                        <!-- Orders -->
                        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-start">
                                <div><p class="text-sm text-gray-500 mb-1">الطلبات</p><h3 class="text-2xl font-bold dark:text-white" id="total-orders-display">0</h3></div>
                                <div class="p-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-lg"><i class="fas fa-shopping-bag"></i></div>
                            </div>
                        </div>
                        <!-- Visits -->
                        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-start">
                                <div><p class="text-sm text-gray-500 mb-1">زيارات الموقع</p><h3 class="text-2xl font-bold text-orange-500" id="total-visits-display">0</h3></div>
                                <div class="p-2 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-lg"><i class="fas fa-eye"></i></div>
                            </div>
                        </div>
                        <!-- Products Count (NEW) -->
                        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-start">
                                <div><p class="text-sm text-gray-500 mb-1">عدد المنتجات</p><h3 class="text-2xl font-bold text-indigo-500" id="dashboard-products-count">0</h3></div>
                                <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 rounded-lg"><i class="fas fa-box-open"></i></div>
                            </div>
                        </div>
                    </div>
                    <!-- Chart -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-4 dark:text-white">إحصائيات المبيعات</h3>
                        <div class="relative h-72 w-full"><canvas id="salesChart"></canvas></div>
                    </div>
                </div>

                <!-- PRODUCTS MANAGEMENT VIEW -->
                <div id="products-view" class="hidden animate-fade-in space-y-6">
                    <!-- Add Product Form -->
                    <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-4 dark:text-white border-b dark:border-gray-600 pb-2">إضافة منتج جديد</h3>
                        <form id="add-product-form" onsubmit="addNewProduct(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">اسم المنتج</label>
                                <input type="text" id="prod-name" required class="w-full px-4 py-2 rounded-lg border dark:bg-gray-800 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">السعر (ج.م)</label>
                                <input type="number" id="prod-price" required class="w-full px-4 py-2 rounded-lg border dark:bg-gray-800 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">رابط الصورة (URL)</label>
                                <input type="url" id="prod-image" required placeholder="https://example.com/image.jpg" class="w-full px-4 py-2 rounded-lg border dark:bg-gray-800 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">القسم</label>
                                <select id="prod-category" class="w-full px-4 py-2 rounded-lg border dark:bg-gray-800 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
                                    <option value="أزياء">أزياء</option>
                                    <option value="إلكترونيات">إلكترونيات</option>
                                    <option value="منزل">منزل</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm text-gray-500 mb-1">الوصف</label>
                                <textarea id="prod-desc" rows="2" class="w-full px-4 py-2 rounded-lg border dark:bg-gray-800 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none"></textarea>
                            </div>
                            <div class="md:col-span-2 text-left">
                                <button type="submit" id="add-btn" class="bg-primary hover:bg-secondary text-white px-6 py-2 rounded-lg font-bold transition-colors">
                                    <i class="fas fa-plus"></i> إضافة المنتج
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Products List -->
                    <div class="bg-white dark:bg-cardDark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h3 class="font-bold text-lg dark:text-white">المنتجات الحالية (<span id="total-products-display">0</span>)</h3>
                            <button onclick="loadProducts()" class="text-primary text-sm hover:underline"><i class="fas fa-sync"></i> تحديث</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500">
                                    <tr>
                                        <th class="px-6 py-3">الصورة</th>
                                        <th class="px-6 py-3">الاسم</th>
                                        <th class="px-6 py-3">السعر</th>
                                        <th class="px-6 py-3">القسم</th>
                                        <th class="px-6 py-3">إجراء</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body" class="divide-y divide-gray-100 dark:divide-gray-700 text-sm">
                                    <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Orders View -->
                <div id="orders-view" class="bg-white dark:bg-cardDark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden animate-fade-in hidden">
                    <div class="p-6 border-b dark:border-gray-700"><h3 class="font-bold text-lg dark:text-white">كل الطلبات</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500">
                                <tr>
                                    <th class="px-6 py-3">رقم الطلب</th>
                                    <th class="px-6 py-3">العميل</th>
                                    <th class="px-6 py-3">العنوان</th>
                                    <th class="px-6 py-3">الدفع</th>
                                    <th class="px-6 py-3">المبلغ</th>
                                    <th class="px-6 py-3">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="divide-y divide-gray-100 dark:divide-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Customers View -->
                <div id="customers-view" class="bg-white dark:bg-cardDark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden animate-fade-in hidden">
                    <div class="p-6 border-b dark:border-gray-700"><h3 class="font-bold text-lg dark:text-white">قائمة العملاء (<span id="customers-count-header">0</span>)</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 dark:bg-gray-800 text-xs uppercase text-gray-500">
                                <tr><th class="px-6 py-3">الاسم</th><th class="px-6 py-3">الهاتف</th><th class="px-6 py-3">العنوان</th><th class="px-6 py-3">عدد الطلبات</th><th class="px-6 py-3">تواصل</th></tr>
                            </thead>
                            <tbody id="customers-table-body" class="divide-y divide-gray-100 dark:divide-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config
        let firebaseConfig;
        let isPreviewMode = false;
        let appId = 'default-app-id';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            isPreviewMode = true;
        } else {
            // Your Production Config
            firebaseConfig = {
                apiKey: "AIzaSyBH7Lxi6qGoVej3PImRv1ndczeihLgucaI",
                authDomain: "elitestore-a55c1.firebaseapp.com",
                projectId: "elitestore-a55c1",
                storageBucket: "elitestore-a55c1.firebasestorage.app",
                messagingSenderId: "238502514492",
                appId: "1:238502514492:web:7feca9e75f5c5c7e4b9839",
                measurementId: "G-JR6FZ45FPG"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allOrders = [];
        let allProducts = [];
        let salesChartInstance = null;

        // Auth
        async function initAuth() {
            try {
                if (isPreviewMode && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth Error:", error); updateStatus("غير متصل", "red"); }
        }
        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                updateStatus("متصل بـ Firebase", "green"); 
                fetchData(); 
                loadProducts(); 
            } 
        });

        function updateStatus(text, color) {
            const statusEl = document.getElementById('connection-status');
            if(statusEl) {
                const colorClass = color === 'green' ? 'bg-green-500' : 'bg-red-500';
                const textClass = color === 'green' ? 'text-green-500' : 'text-red-500';
                statusEl.className = `text-lg font-bold ${textClass} flex items-center gap-2`;
                statusEl.innerHTML = `<div class="w-3 h-3 ${colorClass} rounded-full animate-pulse"></div> ${text}`;
            }
        }

        // --- Data Fetching ---
        window.fetchData = async function() {
            try {
                // 1. Get Orders
                let ordersRef = isPreviewMode ? collection(db, 'artifacts', appId, 'public', 'data', 'orders') : collection(db, 'orders');
                const querySnapshot = await getDocs(ordersRef);
                allOrders = [];
                let totalSales = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allOrders.push({ id: doc.id, ...data });
                });

                allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

                allOrders.forEach(order => {
                    let priceVal = 0;
                    if(order.total) priceVal = parseFloat(order.total.toString().replace(/[^0-9.-]+/g,""));
                    totalSales += priceVal;
                });

                const salesEl = document.getElementById('total-sales-display');
                if(salesEl) salesEl.innerText = `${totalSales.toFixed(2)} ج.م`;

                const ordersEl = document.getElementById('total-orders-display');
                if(ordersEl) ordersEl.innerText = allOrders.length;

                renderOrdersTable();
                renderCustomersTable();
                renderSalesChart();

                // 2. Get Visits
                let statsRef;
                if (isPreviewMode) {
                     statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'general');
                } else {
                     statsRef = doc(db, 'stats', 'general');
                }
                const statsSnap = await getDoc(statsRef);
                const visitsEl = document.getElementById('total-visits-display');
                if(visitsEl) {
                    if (statsSnap.exists()) {
                         visitsEl.innerText = statsSnap.data().visits || 0;
                    } else {
                         visitsEl.innerText = "0";
                    }
                }

            } catch (error) { console.error("Fetch Error:", error); }
        }

        // --- Product Management ---
        window.addNewProduct = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('add-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span> جاري الإضافة...';
            btn.disabled = true;

            const productData = {
                name: document.getElementById('prod-name').value,
                price: document.getElementById('prod-price').value,
                image: document.getElementById('prod-image').value,
                category: document.getElementById('prod-category').value,
                description: document.getElementById('prod-desc').value,
                date: new Date().toISOString()
            };

            try {
                let prodRef = isPreviewMode ? collection(db, 'artifacts', appId, 'public', 'data', 'products') : collection(db, 'products');
                await addDoc(prodRef, productData);
                alert("تم إضافة المنتج بنجاح! سيظهر في المتجر.");
                e.target.reset();
                loadProducts(); 
            } catch (error) {
                console.error("Error adding product:", error);
                alert("حدث خطأ أثناء الإضافة.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        window.loadProducts = async function() {
            try {
                let prodRef = isPreviewMode ? collection(db, 'artifacts', appId, 'public', 'data', 'products') : collection(db, 'products');
                const snapshot = await getDocs(prodRef);
                allProducts = [];
                snapshot.forEach(doc => allProducts.push({ id: doc.id, ...doc.data() }));
                
                const productsDisplay = document.getElementById('total-products-display');
                if(productsDisplay) productsDisplay.innerText = allProducts.length;
                
                // Update Dashboard Home Card
                const dashProductsCount = document.getElementById('dashboard-products-count');
                if(dashProductsCount) dashProductsCount.innerText = allProducts.length;

                const tableBody = document.getElementById('products-table-body');
                if(tableBody) {
                    if(allProducts.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">لا توجد منتجات مضافة بعد.</td></tr>';
                        return;
                    }
                    tableBody.innerHTML = allProducts.map(p => `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700">
                            <td class="px-6 py-4"><img src="${p.image}" class="w-10 h-10 rounded object-cover"></td>
                            <td class="px-6 py-4 font-bold dark:text-white">${p.name}</td>
                            <td class="px-6 py-4 text-primary font-bold">${p.price} ج.م</td>
                            <td class="px-6 py-4 text-gray-500">${p.category}</td>
                            <td class="px-6 py-4">
                                <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded transition-colors" title="حذف"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');
                }

            } catch (error) { console.error("Error loading products:", error); }
        }

        window.deleteProduct = async function(id) {
            if(!confirm("هل أنت متأكد من حذف هذا المنتج؟")) return;
            try {
                let prodRef;
                if (isPreviewMode) {
                     alert("الحذف في وضع المعاينة قد يكون مقيداً.");
                     return;
                } else {
                     await deleteDoc(doc(db, "products", id));
                }
                loadProducts();
            } catch (error) {
                console.error("Delete error:", error);
                alert("حدث خطأ في الحذف.");
                loadProducts(); 
            }
        }

        // --- Renderers ---
        function renderSalesChart() {
            const ctxEl = document.getElementById('salesChart');
            if(!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            const days = {};
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('en-CA');
                days[dateStr] = 0;
            }
            allOrders.forEach(order => {
                if(order.date) {
                    const dateStr = order.date.split('T')[0];
                    if (days[dateStr] !== undefined) {
                        let price = parseFloat(order.total.toString().replace(/[^0-9.-]+/g,"")) || 0;
                        days[dateStr] += price;
                    }
                }
            });
            const labels = Object.keys(days);
            const data = Object.values(days);
            if (salesChartInstance) salesChartInstance.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'المبيعات (ج.م)',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: isDark ? '#374151' : '#e5e7eb' }, ticks: { color: isDark ? '#9ca3af' : '#4b5563' } },
                        x: { grid: { display: false }, ticks: { color: isDark ? '#9ca3af' : '#4b5563' } }
                    }
                }
            });
        }

        function renderOrdersTable() {
            const tableBody = document.getElementById('orders-table-body');
            if(!tableBody) return;
            if (allOrders.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">لا توجد طلبات حتى الآن</td></tr>`; return; }
            tableBody.innerHTML = allOrders.map(order => {
                const paymentMethod = order.paymentMethod === 'فيزا' ? 
                    '<span class="text-blue-600 bg-blue-100 px-2 py-1 rounded text-xs"><i class="fas fa-credit-card"></i> فيزا</span>' : 
                    '<span class="text-green-600 bg-green-100 px-2 py-1 rounded text-xs"><i class="fas fa-money-bill-wave"></i> كاش</span>';
                
                return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700 last:border-0">
                    <td class="px-6 py-4 font-mono text-xs text-gray-500">#${order.id.slice(0,6)}</td>
                    <td class="px-6 py-4 font-bold dark:text-white"><div>${order.customerName || 'مجهول'}</div></td>
                    <td class="px-6 py-4 text-xs text-gray-500 truncate max-w-xs">${order.address || '-'}</td>
                    <td class="px-6 py-4">${paymentMethod}</td>
                    <td class="px-6 py-4 text-primary font-bold">${order.total || '0.00 ج.م'}</td>
                    <td class="px-6 py-4"><span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">جديد</span></td>
                </tr>
            `}).join('');
        }

        function renderCustomersTable() {
            const customersMap = new Map();
            allOrders.forEach(order => {
                const phone = order.phone || 'unknown';
                if (!customersMap.has(phone)) {
                    customersMap.set(phone, { name: order.customerName, phone: phone, address: order.address, count: 1 });
                } else {
                    customersMap.get(phone).count++;
                }
            });
            const customers = Array.from(customersMap.values()).filter(c => c.phone !== 'unknown');
            const custDisplay = document.getElementById('total-customers-display');
            if(custDisplay) custDisplay.innerText = customers.length;
            const custHeader = document.getElementById('customers-count-header');
            if(custHeader) custHeader.innerText = customers.length;

            const tableBody = document.getElementById('customers-table-body');
            if(tableBody) {
                tableBody.innerHTML = customers.map(c => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700">
                        <td class="px-6 py-4 font-bold dark:text-white">${c.name}</td>
                        <td class="px-6 py-4 text-gray-500">${c.phone}</td>
                        <td class="px-6 py-4 text-xs text-gray-500 truncate max-w-xs">${c.address}</td>
                        <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">${c.count} طلبات</span></td>
                        <td class="px-6 py-4"><a href="https://wa.me/2${c.phone}" target="_blank" class="text-green-500 hover:text-green-600 border border-green-500 rounded px-2 py-1 text-xs"><i class="fab fa-whatsapp"></i> تواصل</a></td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center py-8">لا يوجد عملاء</td></tr>';
            }
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.sidebar-link').forEach(l => {
                l.classList.remove('active-link'); l.classList.add('text-gray-600', 'dark:text-gray-400');
            });
            document.getElementById('nav-' + tabName).classList.add('active-link');

            const title = document.getElementById('page-title');
            const dashboardView = document.getElementById('dashboard-view');
            const ordersView = document.getElementById('orders-view');
            const customersView = document.getElementById('customers-view');
            const productsView = document.getElementById('products-view');

            dashboardView.classList.add('hidden');
            ordersView.classList.add('hidden');
            customersView.classList.add('hidden');
            productsView.classList.add('hidden');

            if (tabName === 'dashboard') {
                title.innerText = 'نظرة عامة';
                dashboardView.classList.remove('hidden');
            } else if (tabName === 'orders') {
                title.innerText = 'إدارة الطلبات';
                ordersView.classList.remove('hidden');
            } else if (tabName === 'customers') {
                title.innerText = 'سجل العملاء';
                customersView.classList.remove('hidden');
            } else if (tabName === 'products') {
                title.innerText = 'إدارة المنتجات';
                productsView.classList.remove('hidden');
                loadProducts();
            }
        }

        initAuth();
        document.getElementById('theme-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            renderSalesChart();
        };
    </script>
</body>
</html>
